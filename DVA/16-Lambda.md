## AWS Lambda

- Fass다 (Funtion as a Service)
- 람다는 AWS CLI나, SDK, AWS 서비스에서 호출 가능함
- 람다는 최대 `15분` 까지 실행 할 수 있다.
- `처리량이 많아지면, 오토스케일링 됨`
- 람다 실행 `Ram은 최대 10GB`까지 설정 가능
  - RAM을 높이면, `CPU와 네트워크 품질도 같이 올라감`
- 람다 최대 동시 호출수는 `1000개`  

- 요금 정책
  - 람다 실행 시간
    - `람다 실행이 2.32 ms 걸렷다면, 요금 부과는 3ms로 책정된다`
  - 람다 호출 횟수


--------------------

## AWS Lambda ALB 통합

- 사용자는 HTTP/S로 호출시, ALB를 통해 람다 호출 가능함
- ALB -> 람다로 패킷이 갈때 HTTP정보가 Json 형태로 변환되서 감

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_alb1.png)
![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_alb2.png)


- 반대로 람다 -> ALB 로 정보 변환되서 전달됨

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_alb3.png)

- 멀티 헤더 벨류도 가능하다

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_alb4.png)


---------------------------------------

## AWS Lambda 비동기 호출

- 동기식 호출은, 필요할때마다 AWS CLI나 SDK, API gateway에서 호출한 방식
- `비동기 호출은 결과를 알 수 없음`(`호출만하고 결과는 안봄`) 
- 비동기식은 이벤트 큐에서 람다가 읽어서 처리함 (`대규모 처리`)
  - S3, SNS, 클라우드 와치등이 있다
  - 이벤트 브릿지 cron 잡, code 커밋의 이벤트
- 총 3번 함수를 실행 시도 함 (성공 할때까지)
  - 첫번째는 바로시도, 두번째는 1분뒤, 세번쨰는 2분뒤
- 실패하면 SQS나 SNS로 DLQ를 구성해서 작업 내역 보낼 수 있음

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%EB%B9%84%EB%8F%99%EA%B8%B01.png)











- S3 이벤트를 다이렉트로 받으면, `비동기식 호출로 진행된다`
  - `s3 이벤트는 실시간이 아니다`, 때때로 1분정도 걸리기도 한다
  - 그리고 s3 버저닝을 활성화 해야된다!
    - 같은 파일에 동시작업이 진행될 경우, `하나의 이벤트(최신 버젼) 밖에 받지 못함` 

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%EB%B9%84%EB%8F%99%EA%B8%B02.png)








----------------------------------

## AWS Lambda - 이벤트 소스 맵핑

- 키네시스 데이터 스트림, SQS, SNS FIFO, 다이나모 DB 등 -> `람다가 실행되려면, 이 리소스들을 폴링해야됨`
  - 즉, 람다가 서비스에 레코드를 요청해야됨
  - 이경우, `람다 내부에 이벤트 소스 맵핑이라는 큐가 생김`
  - 이경우, `람다 함수는 동기적으로 호출됨` (레코드를 받고 처리를 해야되니까)

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%EC%9D%B4%EB%B2%A4%ED%8A%B8%EC%86%8C%EC%8A%A4%EB%A7%B5%ED%95%911.png)






- 이벤트 소스맵퍼는 2가지 종류가 있음
  - 1. 스트림
    - 키네시스 데이터 스트림, 다이나모DB 스트림 용
    - 병렬 처리를 사용하면, 샤드당 동시에 `10개 배치`까지 가능
    - 맵퍼는 각 샤드에 폴링을 생성함
    - `만약 배치(처리)에 에러가 날 경우, 영향 받는 배치는 중단됨`


![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%EC%9D%B4%EB%B2%A4%ED%8A%B8%EC%86%8C%EC%8A%A4%EB%A7%B5%ED%95%912.png)


  - 2. 대기열
    - SQS 나 SNS FIFO 용
    - 긴 폴링을 이용해 폴링됨, 배치사이즈는 1~10
    - 람다용 DLQ는 비동기식 호출에만 작동


![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%EC%9D%B4%EB%B2%A4%ED%8A%B8%EC%86%8C%EC%8A%A4%EB%A7%B5%ED%95%913.png)


- 큐와 람다
  - FIFO 대기열에서 `활성 메세지 그룹(그룹ID기반)의 숫자`와, `람다 실행 숫자는 같음`
  - 표준 대기열은 다를 수 있음
  - 람다가 처리하지 못한 아이템은 DLQ로 전달 가능

------------------

## AWS Lambda - 이벤트 & 컨텍스트 오브젝트

- 람다 함수에서 전달받는 `event` 객체, 람다에서 보내는 `컨텍스트 객체(람다정보)`가 있음
- 이벤트 객체
  - Json 형태, 람다 함수가 처리할 데이터를 가지고 있는 문서
  - 이벤트 브릿지, SQS, 커스텀
  - `사용하는 람다 런타임에 따라서, 형태가 바뀜` (파이썬은 dict 형태로 자동 변환)
- 컨텍스트 객체
  - 람다의 런타임 환경, 호출 환경을 기록한 문서
  - 파이썬의 경우, `context` 변수를 print해보면 됨

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%EC%98%A4%EB%B8%8C%EC%A0%9D%ED%8A%B81.png)


--------------------

## AWS Lambda 목적지

- Lambda destinations (목적지)는 `비동기 호출 결과` 또는 이벤트 매퍼의 실패 결과를 다른 어딘가로 전송하는 기능
  - 기존 비동기식 람다 함수를 실행할때, `람다 함수 작업이 성공인지, 실패인지 알 수 없었다.`
- 목적지를 사용하면, 비동기식 호출의 성공 및 실패 `이벤트 모두`를 목적지에 전달 가능
  - 실패는 실패로, 성공은 성공 목적지로도 가능 => `필터도 가능`
- 목적지
  - SQS
  - SNS
  - 람다
  - AWS 이벤트 브릿지 버스
- 그냥 DLQ 쓰면 안됨?
  - `DLQ는 SQS와 SNS로 실패만 전송하도록 하지만, 람다 목적지는 모두(실패 및 성공)를 SQS, SNS, 람다 및 이벤트 브릿지로 전송 가능함`

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%EB%AA%A9%EC%A0%81%EC%A7%80.png)


----------------------------

## AWS Lambda - 환경변수

- 람다 자체에 환경변수를 설정 할 수 있고, 필요하면 `KMS로 암호화 가능함`
- 파이썬 경우 `os.getenv()`로 가져올 수 있음





---------------------------

## AWS Lambda 로깅 & 모니터링

- 람다는 `기본적으로 CW와 통합`되서, 모든 실행 로그는 CW logs에 저장됨
  - 단, CW logs에 기록될 수 있게 IAM 역할이 잘 부여 되있어야함
- 람다는 CW 메트릭과도 통합되어 있음
  - 호출 수, 기간, 동시실행, 오류률, 스로틀 등 제공

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%EB%AA%A8%EB%8B%88%ED%84%B0%EB%A7%811.png)


- `람다에서는 X-Ray를 이용한 추적이 가능함` (Active Tracing 활성화만 해주면 됨)
  - 활성화 후, `람다 코드에 X-ray sdk만 입력` 해주면 설정 완료
  - x-ray IAM 역할도 추가는 해줘야함 (`AWSXRAYDaemonWriteAccess`)
  - `X-ray 관련 람다 대표 환경변수 (3가지)`
    - _X_AMZN_TRACE_ID
      - 컨테이너 추적 헤더
    - AWS_XRAY_CONTEXT_MISSING
      - 기본값은 LOG_ERROR
    - AWS_XRAY_DAEMON_ADDRESS
      - x-ray 데몬의 IP 주소:포트





--------------------------------------

## AWS Lambda@Edge 및 CloudFront Lambda

- 엣지 함수는 전역적으로 배포됨
- 기본 람다 함수는 리전에 배치되어 실행된다. 하지만 엣지 위치에 콘텐츠를 배포 및 람다함수를 써야하는 경우 아래와 같은 람다를 쓸 수 있다.


- CloudFront에서 사용할 수 있는 함수는 2가지 이다
  - `CloudFront Function`
    - 자바스크립트 기반의 `가벼운 함수`, 초당 수백만개 수행 가능
    - `뷰어의 요청/응답만 바꾸는데 사용`
      - 예시) `URL이나 헤더, 쿠키의 속성 변경 등 캐시키 최적화에 특화됨`
      - 인증 요청 가능 (`삽입된 JWT 토큰 검증`)
    - 최대 함수 실행시간 1ms

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%EC%97%A3%EC%A7%801.png)



  - `Lambda@Edge`
    - `노드 JS나 파이썬 기반의 함수`, 초당 1000개 까지 처리 가능
    - `us-east-1 에서 함수 작성`, 그럼 모든 지역에 함수가 복제 됨
    - 뷰어 요청/응답, 오리진 요청/응답 다 적용 가능
      - 예시) 파일 시스템 엑세스해서 HTTP 본문 가져오기 등
    - 최대 함수 실행시간 10초

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%EC%97%A3%EC%A7%802.png)

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%EC%97%A3%EC%A7%803.png)



--------------------------------------

## VPC의 Lambda

- 람다는 기본적으로 VPC 외부에서 실행된다, 따라서 RDS나 엘라스틱 캐시에 접근 불가하다 => 왜? 이런 AWS 리소스들은 VPC 내부에 있기 때문
  - `다이나모 DB는 VPC에 생성되는게 아니라 접근 가능함`



- 그래서 VPC내부에 실행할 수 잇게, 설정 가능하다
  - 람다 함수에 `보안 그룹 및 서브넷을 배정해야됨`
  - 람다는 VPC안에서 사용하면 `ENI`를 생성하는데, 또한 `AWSLambdaVPCAccessExecutionRole` 역할을 부여해야 된다.

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_VPC1.png)

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_VPC2.png)


- 람다를 `VPC 퍼블릭 서브넷에 배포해도 인터넷에 접근이 불가`하다
  - `NAT 게이트웨이/인스턴스를 사용해야 된다!`
  - `람다가 VPC 내부에 있어도, CW 로그나 매트릭은 제대로 작동한다!`

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_VPC3.png)



-------------------------------------------

## AWS Lambda 성능 및 구성

- 람다 구성
  - 램은 1MB씩 증설 가능
  - 램이 1792MB = vCpu 1.0
  - 램이 1792MB 이면, `CPU를 하나 더 얻는데, 다중 스레드 작업을 진행 할 수 있다.`





- 람다 성능
  - 람다는 Execution context(실행 컨텍스트)가 있음
  - 실행 컨텍스트란?
    - 다시 함수가 호출될 것을 예상하고, `일정시간 자원/환경이 유지됨`
    - 즉, 짧은시간 여러번 호출하면 호출에 대한 `컨텍스트를 재사용함`
    - 그래서 람다 함수 실행 (초기화)시간을 줄임
  
  
  
  
  
  
  
  - 아래 그림은 베스트 DB 연결 가이드라인
    - BAD 코드
      - 람다 호출마다 DB 연결함
    - GOOD 코드
      - `핸들러 외부에서 DB연결을 초기화해서 컨텍스트가 초기화 되지 않는이상, DB연결 안해도 됨`

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%EC%84%B1%EB%8A%A51.png)

  - `/tmp` 폴더에 파일을 임시 저장 할 수 있다
    - 용량은 512MB에서 최대 10GB까지 데이터 저장소
    - 또한 컨텍스트가 유지되는 기간에 파일 또한 유지된다
    - 람다 함수 인스턴스가 사라지는 즉시, 스토리지도 사라짐




--------------

## AWS Lambda Layers

- 두가지 기능이 있다.
  - 1.람다의 사용자 지정 런타임을 만드는 것
    - 예시) C++, Rust 돌아가게끔 만듬 
  - 2. 종속성을 다시 사용할 수 있게 외부화 함 (`일종의 패키지 참조`)

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%EB%A0%88%EC%9D%B4%EC%96%B41.png)


------------------------------

## AWS Lambda 파일 시스템

- 람다가 `VPC에서 실행`되면, `EFS에 마운트 가능`함
- 람다가 사용할 수 있는 파일시스템은 4개임 

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%EC%8A%A4%ED%86%A0%EB%A6%AC%EC%A7%801.png)



--------------------

## AWS Lambda 동시성

- 람다는 리전당, 총 최대 1000개까지(`람다 통합`) 동시 실행될 수 있다. 
  - 서비스 쿼타에서 1000개 보다 더 높게 설정도 가능함
- 함수 `수준에서 동시성을 설정 할 수 있다` (아래그림 참조)

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%EB%8F%99%EC%8B%9C%EC%84%B12.png)



- 동시성을 제어하지 않으면 같은 리전의 다른 람다 서비스에 Thottle가 에러 발생한다
![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%EB%8F%99%EC%8B%9C%EC%84%B11.png)



- 비동기 호출 + 람다 동시성 한계를 실행하면, `람다 내부 이벤트 대기열에서 최대 6시간에 걸쳐, 람다를 실행 하려고 함`, 재시도 간격은 지수 백오프 방식으로 증가
- 람다 동시성 한계 에러 코드 2가지
  - 스로틀링 에러 429
  - 시스템 에러 500시리즈




- 람다의 콜드 스타트
  - 람다 함수 인스턴스를 생성할 때를 `초기화`라고 한다
  - 만약 대규모 람다함수 초기화가 발생할 경우, `종속성이나 이런 작업때문에 오랜 시간이 걸릴 수 있다`
  - 이럴때 `프로비저닝된 동시성`을 사용하면, 해결 가능
    - 함수가 호출되기전에, 동시성을 미리 할당 해 놓음
    - 프로비저닝된 동시성은 `람다의 최신버전이 실행 불가능`




![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%EB%8F%99%EC%8B%9C%EC%84%B13.png)



--------------------

## AWS Lambda 외부 종속성

- 실무에 런타임의 많은 패키지, 종속성을 사용할때 추가해야되는 요소
- 모든 패키지는 `zip`파일로 압축해야됨
  - 패키지 크기가 `50MB 이하`면 람다에 `바로 업로드` 가능
  - 패키지 크기가 `50MB 이상`이면 `S3에 올려 람다에서 참조`
    - 이경우, 람다가 S3 참조 역할 있어야함
- AWS SDK는 모든 람다에서 사용가능함


----------------------------------

## AWS Lambda와 CloudFormation

- 클라우드 포메이션으로 람다함수를 배포 가능
  - 인라인 방식
    - 간단한 경우에만 사용
    - `외부 종속성 파일을 업로드 불가`


![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%ED%8F%AC%EB%A9%94%EC%9D%B4%EC%85%981.png)





  - S3를 통해
    - `람다 zip파일을 S3에 업로드`
    - S3Bucket
      - S3 버킷 이름
    - S3Key
      - 버킷에서 zip파일 위치
    - S3ObjectVersion
      - S3에서 `객체의 버전ID`


![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%ED%8F%AC%EB%A9%94%EC%9D%B4%EC%85%982.png)

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%ED%8F%AC%EB%A9%94%EC%9D%B4%EC%85%984.png)





  - S3를 통해 다수 계정 배포
    - 오리진 버킷의 정책을 설정해서 다른계정에서 접근 가능
    - 또한 참조하는 곳에서 클라우드 포메이션이 실행될수 있게 리스팅을 허용해야함

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%ED%8F%AC%EB%A9%94%EC%9D%B4%EC%85%983.png)


------------------------------------

## AWS Lambda 컨테이너 이미지

- ECR에 람다 배포용 컨테이너 이미지를 저장 할 수 있음 (`최대 10GB`) 
- 종속성, 환경 셋팅을 미리 다 해둘수 있음
- 도커 컨테이너가 아님! `람다 컨테이너임!`
  - 도커 이미지 위에, 람다 런타임을 구현해야 됨

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%881.png)


- 이미지 빌드 예시

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%ED%8F%AC%EB%A9%94%EC%9D%B4%EC%85%981.png)




----------------------------------

## AWS Lambda 버전 및 별칭

- 람다 버전
  - 현재 작업중인 람다는 `$LATEST`로 게시되며, `코드변경 가능`
  - 게시를 하면, (샘플)버젼 `V1`으로 배포가 되며, `코드,환경변수 등 변경은 불가능해짐`
  - `람다의 버젼별 각각 다른 ARN(아마존 리소스 네임)을 가짐`


![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%EB%B3%84%EC%B9%AD1.png)




- 람다 별칭
  - 람다 별칭은 최종 사용자에게, `안정적인 엔드 포인트를 제공하기 위함`
  - 람다 별칭은 블루/그린 배포도 가능하다 (`가중치 트래픽`)
  - `람다 별칭도 각각 다른 ARN(아마존 리소스 네임)을 가짐`
  - 별칭은 `다른 별칭을 참조 할 수 없음`

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_%EB%B3%84%EC%B9%AD2.png)



--------------------------

## AWS Lambda & CodeDeploy

- Codedeploy를 사용하면 람다 `버전과 별칭에 빌드함`
- CodeDeploy를 통해 람다의 트래픽 제어를가능케 함
  - 선형적
  - 카이나리
  - 한번에 바꾸기
- CodeDeploy를 통해 롤백도 가능함, 클라우드 와치 알람 + CodeDeploy 감지를 통해 롤백 수행

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_code1.png)




- CodeDeploy의 AppSpec.yml 파일은 아래 그림과 같다

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_code2.png)



------------------------------

## AWS Lambda URL

- 람다를 URL로 호출 가능한 기능 (ipv4와 ipv6 지원)
- 활성화는 사용자 마음 (기본값은 URL 생성 안되있음)
- 다른 도메인을 통해 람다 URL에 엑세스할 경우, `CORS 구성도 가능`
- 인터넷을 통해 URL 엑세스 가능, `프라이빗링크 통해서 URL 호출 불가능`
- 람다 URL은 함수의 특정 버전이나 설정 불가능, `무조건 $LATEST로 불러짐`

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_URL1.png)

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_URL2.png)




- 람다 리소스 기반 `URL` 보안
  - 보안그룹 처럼 CIDR 접근제어, 특정한 IP
  - IAM 사용자,역할 등 설정 가능
  - CORS 설정
  - `AuthType = None` 으로 설정하면 `노 인증 호출`
  - `AuthType = AWS_IAM` 으로 설정하면 IAM 기반 인증
    - 호출 대상은 `lambda:InvokeFuntionURL` 권한을 가지고 있어야함
  - 호출 대상이 같은 계정이라면, `ID기반 정책 or 리소스기반 정책이 허용되야함`
  - 호출 대상이 다른 계정이라면, `ID기반 정책 and 리소스기반 정책이 허용되야함`

![Alt text](../etc/image3/%EB%9E%8C%EB%8B%A4_URL3.png)

-------------------------------

## AWS Lambda 기타

- 코드 그루랑 연동됨
  - 코드 리뷰
  - 함수 프로파일링 가능
  - 람다에 `AmazoncodeGuruProfilerAgentAccess` 권한 필요


- 람다 제한
  - 환경변수는 최대 4KB
  - tmp 폴더는 기본 512MB 할당됨 10GB까지 확장 가능
  - 람다 코드 패키지 zip 파일은 50MB
  - 람다 코드 패키지 노압축 파일은 `250MB`


- `재귀 코드는 절대 사용해서 안된다!`
  - 람다가 자기 자신을 호출하면 정말... 큰일남






























































