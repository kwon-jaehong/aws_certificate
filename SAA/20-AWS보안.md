## AWS 보안

- `시험에 보안에 관한 문제가 많이 출제됨`
- cloudHSM은 시험범위에 없음


---------------
## AWS KMS (aws key management service)

- 시험문제에서 서비스에 관한 `대부분 암호화는 KMS임`
- AWS KMS는 주로 데이터 암호화 키 및 기타 AWS 리소스의 관리에 사용됩니다.
- KMS 키를 사용하기 위한 API호출을 `Cloudtrail에서 볼 수 있음`




<br>

<br>
<br>



- KMS 키 암호화 종류 (2가지)
  - 대칭키 - Symmetric (AES-256 키)
    - 키가 `하나임`
    - `데이터 암/복호화에 사용`
    - `키에 절대 접근 할 수 없고`(내용을 볼수없고), 사용하려면, 무조건 KMS API 콜 해야됨
  - 비대칭키 - Asymmetric (RSA & ECC 키) (`SAA 시험에 안나옴`)
    - 키가 `2개임` (퍼블릭 키, 프라이빗 키)
    - KMS에서 퍼블릭키는 다운 받을수 있지만, `프라이빗 키에는 엑세스 불가`
    - AWS 클라우드 외부에서 암호화 할때 사용

- KMS 키 유형 (3가지)
  - 10000번 API 콜에 0.03달러
  - `AWS Managed Key`
    - 무료
    - 이름은 `aws/서비스 이름`
    - rds, ebs (aws/rds , aws/ebs 이름으로 키생성됨)
    - `자동으로 1년에 한번씩 교체됨`
  - `CMK`
    - 고객이 AWS KMS에서 키를 생성할 경우 (`Customer managed Keys`)로 할 경우 1달러/1달 비용 발생
    - CMK 사용하려면, `반드시 1년에 한번 교체되도록 활성화` 해야됨
      - `교체 빈도 수정 불가!`
  - `CMK imported`
    - 고객이 키 자체를 입력(256비트 문자열)을 입력해서 키 생성, CMK적용되어 1달러/달 비용 발생
    - `오직 수동으로만 키 교체`


- KSM은 리전에 따라 다름
  - 서울 리전은 키A, 스톡홀름 리전 키B라고 가정
  - 아래 그림은 EBS스냅샷을 다른곳으로 복사할때 발생하는 일임
  - 스냅샷 이동할때 -> 즉, 키A로 복호화, `키B로 암호화를 함` ( AWS에서 `자동으로 처리`)

![Alt text](../etc/image2/KMS%EC%8A%A4%EB%83%85%EC%83%B7%EC%9D%B4%EB%8F%99.png)



- KMS 키 정책
  - `KMS 키 정책`이 없으면, 누구도 `접근 불가능`
  - KMS 키관련, 2가지 정책이 있다
    - Default KMS Key policy
      - 기본 정책은 `고객이 KMS 키정책을 따로 만들지` 않는한, 이 정책이 적용됨
      - 계정의 `모든 유저가 키에 엑세스 허용`
    - Custom KMS key policy
      - KMS키에 엑세스 할 수있는 사용자, 또는 역할을 정의
      - KMS키에 관한 cross-account access (`다른 AWS계정에서 내계정 키 엑세스 허용`)할때 매우 유용
      - cross-account access 언제사용하나?
        - 계정간 스냅샷을 복사할때 사용

![Alt text](../etc/image2/KMS%EA%B3%84%EC%A0%95%EA%B0%84%EC%8A%A4%EB%83%85%EC%83%B7%EB%B3%B5%EC%82%AC.png)


------------------------------------------------------
## AWS KMS Multi-Region key 멀티리전키

- KMS 키는(기본값인, AWS 관리형) `기본적으로 리전 단위`
- 하지만 키를 `고객이 생성`할 경우, 멀티 리전으로 만들 수 있다.
  - 하나의 `키가 복사`되는것임
- 원본 키를 `자동 교체(1년주기)`로 교체하면, 다른것들도 `자동으로 바뀜`


- 하지만, `다중 리전 키는 전역적으로 사용할 수 없다`
  - 각 복사본 키들은, 각 리전에서 `독립적으로 관리`된다 (복사는 되었더라도 정책을 일일이 관리해줘야한다) `키를 하나라고 생각 해서는 안된다!`
- 다중 리전키 사용은... 권장하지는 않음

![Alt text](../etc/image2/KMS%EB%A9%80%ED%8B%B0%EB%A6%AC%EC%A0%84%ED%82%A4.png)




- 예시) 한 리전에서 스냅샷 암호화 -> 다른 리전에서 스냅샷 복호화
- 예시) `글로벌 다이나모, 오로라 DB 테이블 암호화` -> 서울 리전에서 암호화, 오하이오에서 복호화

-------------------------------------
## 암호화된 S3 복제

- 기본적으로 S3 리전간 복제를 하면, `SSE-S3`를 이용해, 암호화된 객체가 복제된다
- 고객이 만든 `SSE-C`키는 복제에 사용 할 수 없다 -> 항상 키를 제공해야되기 떄문에
- `SSE-KMS`키로 암호화 하고, 복제도 된다. 단, 옵션 `활성화` 필요 
  - 버킷내 `특정 객체`를 지정해야됨 (자동안됨)
  - S3 복제를 허용하는 정책, `kms:encrypt`, `kms:encrypt`만들어서 연결 해줘야 함
- `멀티 리전키 쓰면, 암복호화 간편하게 됨`
- SSE-C와 SSE-KMS 차이는, 둘다 고객이 만들지만, 차이점은 고객이 암호화 키를` 직접 관리하느냐 `아니면` AWS KMS를 사용하여 관리`하느냐에 있습니다.

-------------------------------
## AMI 암호화 공유 - KMS

- `AMI를 만들때`, KMS으로 암호화 할수 있음
- 암호화된 AMI 공유하는법
  - `AMI 속성`에 다른 계정에서 사용할수있게 시작 권한을 수정
  - KMS를 공유하기 위한 IAM역할,정책 생성해서 `KMS 키 공유`

![Alt text](../etc/image2/KMSAMI%EC%95%94%ED%98%B8%ED%99%94%EA%B3%B5%EC%9C%A0.png)

------------------------------
## AWS SSM parameter Store 
- `config 및 암호 저장`을 위한 보안 `스토리지`
- 서버리스
- 스토어에 버저닝 기능 있음 ( 과거 데이터 추적 가능 )
- 이벤트브리지 연동 가능
- CloudFormation과 연동해, 스택의 매개변수로도 활용 가능 -> 쿠버네티스 `configmap`와 비슷

- 2가지 티어 있음
![Alt text](../etc/image2/SSM%ED%8C%8C%EB%9D%BC%EB%AF%B8%ED%84%B0%EC%8A%A4%ED%86%A0%EC%96%B4%ED%8B%B0%EC%96%B4.png)

- 어드밴스에서 사용 할 수 있는 `매개변수 정책 이란`?
  - `TTL을 할당 할 수 있음`
  - 여러 조건을 달 수 있음

![Alt text](../etc/image2/SSM%ED%8C%8C%EB%9D%BC%EB%AF%B8%ED%84%B0%EC%8A%A4%ED%86%A0%EC%96%B4%EC%A0%95%EC%B1%85.png)

-----------------------------

## AWS Secrets Manager

- 암호를 저장하는 최신 서비스, 파라미터 스토어와는 다름
- `X일마다 강제로 암호 교체`
- 자동생성은 `Lambda를 연동`해서 생성 가능
- `RDS`와 통합가능
- KMS를 통해 암호화됨

- `멀티리전` 기능도 있음
  - 복수 리전에 동일한 데이터 존재가능함

![Alt text](../etc/image2/%EC%8B%9C%ED%81%AC%EB%A6%BF%EB%A7%A4%EB%8B%88%EC%A0%80%EB%8B%A4%EC%A4%91%EB%A6%AC%EC%A0%84%ED%82%A4.png)

----------------------------------
## AWS Certificate Manager (ACM)

- TLS/SSL 인증서를 `생성,관리,배포` 해주는 서비스
- 퍼블릭/프라이빗 TLS 제공, (퍼블릭 TLS 무료)
- 자동 갱신 가능
  - 갱신에는 DNS, 이메일 인증이 있고, 자동 갱신하려면 DNS인증이 나음
  - ACM 외부에서 생성된 인증서는 `갱신 불가`
- `Ec2인스턴스에서는 사용 못함`
- 리전 서비스임 (글로벌 아님)
- 엣지 최적화 API Gateway는 배후에서 AWS가 관리하는 사용자 지정 CloudFront 배포를 사용하여 CloudFront 엣지 로케이션을 거쳐 전 세계로 요청을 라우팅하기 때문에 ACM 인증서는 us-east-1 리전에 생성해야 합니다.

---------------------------------------
### AWS WAF (웹 애플리케이션 파이어웰)
- IP 필터링 서비스
- 레이어 7에서 작동 (http)
- web `ACL` (웹 엑시스 컨트롤 리스트)에 정의할 수 있음
- ip 범위나` 특정 주소, http 헤더,보디 내용 필터링, 또한 sql 인젝션이나 XSS` 같은 공격을 막을수잇음
- geo-match로 `특정 국가 블럭`
- `이벤트 횟수를 계산해서 ddos 막음` (사용자는 1초당 5개 이상의 이벤트를 발생시킬수 없음 등)

- 적용 대상
  - ALB
  - API gateway
  - cloudFront
  - appsync graphQL API
  - AWS congnito user fool
- `NLB에 배포 못함 -> 레이어 7이니까`
- ALB에 적용하려면(ALB는 고정IP가 없음), AWS global accelerator로 연결(글로벌 악셀은 고정IP 생성해서 연결이니까)
<br>
<br>

`*웹공격은 무조건 WAF임, 쉴드는 디도스만임*`

<br>
<br>


--------------------------
## AWS Shield

- Ddos 공격 막기용
- 제품 카탈로그는 아래와 같음

<br>
<br>

  - AWS shield standard
    - 추가 비용 없음
    - 알아서 자동으로 활성화됨
    - `레이어 3/4 공격을 방어`

<br>
<br>

  - AWS shield advanced
    - 비용 유료
    - `EC2, ELB, cloud front(CDN), AWS global accelerator` 및 `라우트 53`에서 실행되는 애플리케이션임
    - `조직당 매월 3000달러`
    - 클라우드  front 및 라우트53은 글로벌 엣지 네트워크로 보호, 쉴드랑 결합
    - 디도스 대응 팀 (DRP)이 따로 있음 `ddos response team`
    - 디도스 공격으로 받아서 오토스케일링이나 자원이 증가하면 -> 이비용은 AWS에서 냄


-------------------------------

## AWS FirewallManager

- `AWS Organizations`에 있는 `모든 계정의 방화벽 관리` 서비스
- 보안 정책을 설정 할 수 있음
  - `WAF 규칙` (ALB,API 게이트웨이,클라우드 프론트)
  - `AWS 쉴드 어드벤스` (ALB,CLB,NLB,Eip,클라우드 프론트)
  - `보안그룹` (Ec2,ALB,ENI)
  - 라우트 53
- 정책은 `리전 수준`에서 생성 (글로벌하게 `일괄적용은 유연하지 못하기` 때문)
- 설정하면, 조직에 등록된 모든계정에 적용됨 (`자동 적용임`)


--------------------------------------
## 디도스 공격 효과적인 방어 예시

다시 들어야 할듯


----------------------------------
## AWS Guard duty

- `AWS 계정을 보호하는 지능형 위협탐지 서비스`

- 백엔드에서 머신러닝 알고리즘이 이상탐지를 수행하고, 타사 데이터를 이용해서 `AWS 계정에 대한 공격을 감지`
- `분석 소스 데이터`는
    - `클라우드 트레일`
    - s3 데이터 이벤트
    - vpc flow 
    - dns logs
    - 쿠버네티스 audit logs (EKS)
    - 클라우드 워치룰과 연동해서 이벤트 발생시 알람 받을수잇음
  - 이 서비스로 암호화폐 공격(`공격 이름이 암호화폐 공격임`)을 보호할 수 있음 (관련된 전용 탐지기가 있음)

<br>
<br>




---------------------------------------
## AWS inspector

- `AWS 인프라의 자동 보안 평가`에 사용함

- 지원 유형은 
    - EC2
        - `SSM 에이전트`를 통해(ssm이 설치되어있어야함) os,네트워크 접근성 분석해줌
    - ECR - 푸쉬되는 컨테이너를 분석, 이때 모든 리포트는 aws security hub에 전달됨

<br>

`무엇을 평가하나?`
- 무조건 `Ec2` 인스턴스와 `컨테이너만` 검사함
- 이 둘의 `네트워크 패킷`을 검사도 해줌
- 또한 ec2에서 네트워크 접근성을 평가함
- 평가가 끝나면 `risk score` 점수를 얻게 됨

<br>
<br>

-----------------------------------------

## AWS Macie 

- 완전 관리형 데이터 개인 정보 보호 서비스
- 머신러닝과 패턴매칭을 이용해서 aws내에서 민감한 정보를 발견 및 보호
- `민감한 데이터에 대해 경고를 보냄`
- 예) 만약 내 계좌번호.txt 파일이 s3버킷에 저장되면, macie가 개인정보인지 분석해서 cw 이벤트 브릿지로 보냄->알람!
- `s3 버켓에서 일어남`


<br>
<br>





















