## 메세징 소개



- 애플리케이션간의 통신 패턴
  - 1. 직접 통신
    - 애플리케이션 to 애플리케이션
    - 동기적 통신
    - 애플리케이션끼리 커플링 사태가 일어남 
      - 한놈 죽으면 다른놈도 죽음

  - 2. 간접 통신
    - 비동기적
    - 메세지나 이벤트를 전달하는 컴퓨터가 따로 있음
    - `디커플링 방식`


-------------------------------------
## AWS SQS

- SQS의 핵심은 `대기열`임
- SDK를 이용해서 사용 가능 (SendMeassage , DeleteMessage API)
- `무제한 처리량`, 초당 원하는 만큼 메세지를 보낼수있음, 메세지 보관도 제한없음
- 기본값으로 4일 메세지 유지, 최대 14일
- 매우 적은 레이턴시
- 하지만 메시지 크기는 최대 `256KB`
- `중복 메세지`를 가질 수 있음
- 소비자가 읽고, `메세지를 삭제`해야됨 (안하면 큐에 남아있음)
- 기본값으로 소비자는 한번에 최대 10개의 메세지를 받음
- `FIFO Queue 모드` 가능 (기본값은 standard 모드)
  - 중복 방지 설정도 있음
- `Group ID`를 가질수 있고, 그룹마다 소비자를 가질수 있음



SQS 보안
- 암호화는 `HTTPS` API를 사용해 전송중 암호화 됨
- KMS 키를 사용해서 암호화 됨 (서버사이드)
- 원한다면 client-side방식도 됨 (이건 AWS 지원이 아님)
- IAM 정책을 통해 SQS API를 컨트롤
- S3 같이, `SQS Access policies(SQS 정책)이 있음`
  - 교차계정 SQS사용, s3 연동에 유용함 (`다른 리전, 계정에 메세지 전달 가능`)



visibility timeout - 메세지 가시성 타임아웃
- visibility timeout = 30초 예 (기본값도 30초임)
- `메세지-1`를 `소비자-1`에서 받으면, `소비자-2`는 메세지-1을 30초동안 볼 수 없다
- 만약 소비자-1에서 메세지-1이 처리가 안되면(30초 넘어가는)상황이 발생했을때, 처리하기 위함
- 이 시스템은 같은 메세지에 대해 2번 처리 될수 있다는 의미임(여러 소비자에 의해)
- `ChangeMessageVisibility API`를 사용하면, 소비자는 큐에 메세지 `처리에 더 걸릴거 같다`를 업데이트 할 수 있음



Long polling 
- 소비자가 대기열에 아무것도 없다면, 메세지 도착을 기다리는 행위
- 소비자가 `Long polling`상태이면, 빈 메세지큐에 메세지가 들어오면 바로 `소비자에게 전달`
- 1~20초 사이로 설정 가능


+ Autoscaling

- 클라우드 와치 메트릭스로 SQS의 메세지 대기열이 1000 넘어가면 -> CW 알람 -> 오토스케일링그룹 스케일 아웃



----------------------------------------------------------
## AWS SNS

- 메세지 전파
- pub/sub 패턴 사용 (topic 기반)
- 100,000 topic 운영 가능
- topic당 12,500,000 구독자를 가질 수 있음 
- SQS와 마찬가지로 `SDK로 메세지 퍼블리시` 가능
- `FIFO Queue 모드` 가능 (기본값은 standard 모드)
- `메세지 필터링`도 가능
  - Json `규칙에 해당되는 메세지만 발송`

SNS 보안 (`SQS와 같음`)
- 암호화는 `HTTPS` API를 사용해 전송중 암호화 됨
- KMS 키를 사용해서 암호화 됨 (서버사이드)
- 원한다면 client-side방식도 됨 (이건 AWS 지원이 아님)
- IAM 정책을 통해 SNS API를 컨트롤
- S3 같이, `SNS Access policies(SNS 정책)이 있음`
 - 교차계정 SNS 사용가능 (`다른 리전, 계정에 메세지 전달 가능`)


Fan out 패턴
- SNS + SQS를 조합한 패턴임
- 하나의 메시지를 여러 개의 수신자에게 전달하는 메시지 라우팅 메커니즘
- 구매 이력을 SNS 날리고 -> SNS는 두개의 SQS에 날림 -> 각 소비자들은 `똑같은 메세지로 다른일 수행`
- 이패턴을 사용하려면, FIFO(메세지 정렬) + 중복 메세지 제거가 필요하다

![Alt text](../../etc/image2/SNS%20%ED%8C%AC%EC%95%84%EC%9B%83%20%ED%8C%A8%ED%84%B4.png)




-----------------------------------------
## AWS Kinesis

- 실시간 스트리밍 데이터를 수집,처리,분석 할 수 있는 도구
  - 애플리케이션 로그, 매트릭스, 웹사이트 클릭 스트림, Iot 데이터 등

4가지 서비스 존재
- Kinesis Data Streams
  - 데이터 스트림 `수집`,`처리`,`저장`
- Kinesis Data Firehose
  - AWS 내부나 외부 저장소에서 `데이터 스트림을 load`함
  - 데이터를 전송하거나 데이터 변환 과정을 거치고자 할 때 사용
- Kinesis Data Analytics
  - `SQL언어나 Flink`를 활용해서 데이터 스트림 `분석`
- Kinesis Video Streams (시험에 거의 안나옴)
  - `비디오 데이터`를 수집,처리,저장








Kinesis Data Streams
- 키네시스 데이터 스트림은 `여러개의 샤드로 구성` -> `샤드는 고객이 프로비저닝` 해야됨
- 데이터는 모든 샤드에 분배됨
- 샤드당 (초당 1Mb 메세지 or 1000개의 메세지 처리 가능) -> 6개 샤드면 초당 6MB/6천개 메세지 처리
- 생산자에서 데이터를 전달을 `레코드`라함
  - 파티션키 -> 레코드가 이용할 샤드를 결정
    - 파티션키를 기반으로 데이터 정렬할 수 있다
  - Data blob -> 실제 데이터 (최대 `1MB`)
  - Sequence number -> 샤드에서 데이터 번호
- 데이터 보존기간은 1~365일 -> 즉, 데이터를 다시 처리하거나 확인 할 수 있다. (일종의 DB 역할)
- 데이터가 키네시스에 들어오면 `삭제할 수 없다` (`데이터 불변성 확보`)
- 생산자는 SDK, 키네시스 프로듀서 lib (KPL), 키네시스 에이전트 등을 이용해서 키네시스에 데이터 전송
- 소비자는 SDK, 람다,EC2, 파이어호스, 키네시스 클라이언트 lib
- 두가지 용량 모드가 있음
  - provisioned mode(미리 용량 선언)
    - 샤드수를 정하고 수동 설정
    - 샤드를 프로비저닝 할 때마다, 시간당 요금
  - On-demand mode
    - 프로비저닝 필요 X, 자동 조절됨
    - 기본적으로 초당 `4MB/4000`개 레코드 처리 가능 (provisioned 샤드 4개랑 같네)
    - `30일동안 관측한 최대 처리량에 기반해 자동 스케일링 됨`
    - 비용은 시간당 송수신 데이터양(GB단위)에 따라 요금 청구
    - `사전에 사용량을 예측 할수없을때 사용`
- `보안은 SQS나 SNS와 같다`

 ![Alt text](../../etc/image2/%ED%82%A4%EB%84%A4%EC%8B%9C%EC%8A%A4%EB%8D%B0%EC%9D%B4%ED%84%B0%EC%8A%A4%ED%8A%B8%EB%A6%BC.png)






Kinesis Data firehose
- 생산자에게 `데이터를 가져오`는 `완전관리형` 서비스
  - 서버리스, 자동 스케일링, `거의 실시간` != 실시간 (수신할때 `배치` 처리하기 때문)
    - 한번에 적어도 1MB 데이터가 될때까지 기다림
    - 아니면, 배치 크기에 맞춰, 60까지 기다림
- 여러 데이터 형식과, 압축,변환을 지원함
- 비용은 `파이어호스에 통과하는 데이터에 대해서만 지불`
- 데이터 스트림과 비슷하지만, `람다` 적용,배치 적용 등을 할 수 있음
- 수신은 AWS 영역(S3,redshift,엘라스틱서치), 써드파티(데이터독,몽고DB 등), 사용자 지정 HTTP endpoint
- 모든 데이터를 S3에 보내거나, 쓰지이 않는데이터만 필터링 해서 보내거나 할 수 있음
- `데이터 스토리지에 저장하는 것이 아님`, 그래서 `수신자가 메세지를 반복적으로 읽지 못함`



![Alt text](../../etc/image2/%ED%82%A4%EB%84%A4%EC%8B%9C%EC%8A%A4%ED%8C%8C%EC%9D%B4%EC%96%B4%ED%98%B8%EC%8A%A4.png)





----------------------------------------

## AWS amazon MQ
- SNS,SQS는 아마존 독점 기술이기 때문에 클라우드 상에서만 작동함(클라우드 네이티브 기술)
- 온프라미스에서 구성된 메세지 시스템 경우 -> SNS나 SQS로 마이그레이션 하기 힘듬
- 기존에 쓰는 MQTT,AMQP같은 프로토콜을 쓰려면 MQ를 써야함
- AWS MQ 지원 제품군  
  - 레빗 MQ
  - active MQ
- SQS / SNS 처럼 `무한 확장은 할수없음`, 다중 AZ 지원


























