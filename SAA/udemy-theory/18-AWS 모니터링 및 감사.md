## AWS Cloudwatch Metrics - 클라우드워치 지표

<br><br>

- AWS의 모든 서비스에 대한 메트릭(지표)를 제공함
  - 메트릭 = 모니터링 할 변수 ( Ec2의 CPU사용율,네트워크 in 패킷 등)
  - 메트릭은 namespaces에 속하므로, 각기 다른 이름 공간에 메트릭이 저장 됨
  - 서비스당, namespaces는 `하나임`
    - 예를 들어, 모든 Ec2의 CPU사용률 평균은 `CPUUtilization: Average` 이름에 저장됨
- 메트릭당 최대 10개의 차원 데이터 지원 
- 메트릭은 반드시 타임 스템프를 가짐 ( 시간 데이터니까 )
- 사용자 지정 메트릭스도 만들 수 있음
- 메트릭은 Streams로 -> `키네시스 Data firehose, datadog 등 전송 할 수 있음`



- `향상된 모니터링 메트릭 RDS` 제공 정보
  - RDS 프로세스
  - OS 프로세스
  - RDS 하위 프로세스


<br><br><br><br>

- ec2에서 경보를 생성하고, 재부팅, 종료, 중지 등 바로 할 수 있음

![Alt text](../../etc/image2/cw%EA%B2%BD%EB%B3%B4%ED%9B%84%EC%9E%91%EC%97%85.png)




<br><br><br><br>




--------------------------
## AWS Cloudwatch Logs- 클라우드워치 로그

<br><br>

- `로그와 매트릭을 헷갈리면 안됨!`
- `log groups` 애플리케이션 로그들은 로그그룹화 됨
- `log stream` 하나의 로그라고 보면됨 (로그파일 / 애플리케이션 리소스 등)
- 로그들을 기간 만료하지 않게 정책 설정 가능( 기본은 만료됨 )
- 로그 전송 (외부 저장공간 및 응용)
  - S3 -> `실시간이 아니고, 12시간 까지 걸릴수 있음`
    - 실시간으로 받으려면 `subscription filter (구독 필터)`를 설정 해야됨


<br><br>

로그 소스
- SDK, cloudwatcg logs agent, cloudwatch unified agent
- beanstalk -> 애플리케이션 로그를 모아서 전송
- ecs -> 컨테이너 로그
- lambda -> 람다 실행 로그
- VPC flow logs -> vpc 트래픽 로그
- api gateway -> 받은 모든 요청 로그
- cloudtrail  -> 필터링한 로그들 받을 수 있음
- route53 -> 모든 DNS 쿼리를 로그로 받을 수 있음



![Alt text](../../etc/image2/%ED%81%B4%EB%9D%BC%EC%9A%B0%EB%93%9C%EC%99%80%EC%B9%98%EA%B5%AC%EB%8F%85%ED%95%84%ED%84%B0.png)

<br><br><br><br>

- subscription filter는 여러 리전의 로그들을 한곳에 모을 수도 있음
  - `여러 AWS 계정 log 통합도 가능`

![Alt text](../../etc/image2/%ED%81%B4%EB%9D%BC%EC%9A%B0%EB%93%9C%EC%99%80%EC%B9%98%EA%B5%AC%EB%8F%85%ED%95%84%ED%84%B02.png)






<br><br><br><br>


매트릭 & 로그 필터 / `인사이트`
- 지표,매트릭 모두 필터링해서 사용 할 수 있다
  - 로그에서 특정 IP를 찾는다던지
  - 특정 메세지에 "ERROR"라는 문구가 있는지
- 필터를 통해 `클라우드워치 알람`과 연동 가능
- `log 인사이트를 통해 SQL검색 가능`, 자주 쓰이는 쿼리 저장

<br><br><br><br>

-------------------------------------------------------

## AWS Cloudwatcg logs agent, Cloudwatch unified agent

<br><br>

- 기본적으로 Ec2의 로그는 안받아옴 -> Ec2에 cloudwatch 에이전트 깔면 보임 (온프라미스 장비도 설치하면, 가능)
- IAM에서 로그를 보낼수있게 역할을 만들어 줘야함

<br><br>

에이전트는 2가지 종류가 있음
- `logs agent`
  - 오래된 에이전트이고, `오로지 로그만 보냄`
- `unified agent - 통합 에이전트`
  - `Ram, 로그, 프로세스 등` 추가적인 정보도 함께 보냄
  - `매트릭 정보와 로그`를 둘다 사용하기 때문에 `통합 에이전트`라고 하는것임
  - 세부 지표를 얻으려면, `무조건 클라우드 와치 통합 에이전트 깔것`


<br><br><br><br>


-------------------------------------
## AWS CloudWatch Alarms

<br><br>

- 알람은 오직 `매트릭`에서 트리거 가능
  - 로그를 트리거 하려면, 로그 -> 매트릭 변환 후 -> 알람 설정
- 알람 상태 `3가지`
  - OK
  - INSUFFICIENT_DATA (데이터 부족)
  - ALARM (알람 알람~)
- preiod (평가 기간)
  - 내맘대로 설정 할수있음, 5분 10분 등

- 주 타겟
  - Ec2, 오토스케일링 그룹, SNS

- AWS CLI 명령어를 통해, 알람을 임시로 발생 시킬수도 있음

<br><br><br><br>

--------------------
 ## AWS Event Bridge

<br><br>

- 이벤트 버스를 생성해 운영 하는 방식
- AWS말고, 외부 제품 이벤트랑 연동 
- `서버리스`
- `이벤트를 아카이빙 할 수 있음(저장)`
  - 아카이브된 이벤트, `재생`도 가능함
- 이벤트는 `Json형식`으로 발생
- 이벤트 룰(`트리거`) 2종류
  - `스케쥴 기반` = cronjob
    - 예) 1 시간 마다 특정 람다함수 호출, 루트 유저 접속할때마다 이메일 보내기 등...
  - `이벤트 기반`
    - 예) IAM 접속 -> 트리거해서 SNS 이메일 날림 
- `이벤트 정책`을 통해, 다른 AWS 계정의 이벤트를 `내 이벤트 버스`로 통합 시킬 수 있음 (정책 없으면, 내 이벤트만 컨트롤)
<br>
<br>

이벤트 버스 종류
- `default event` 버스 
  - 다른 이벤트 버스들 안쓰면, 클라우드 와치 이벤트와 똑같다
- `파트너 이벤트` 버스 
  - `datadoc`, zendsk 등 이벤트를 받을 수 있다
- `사용자 이벤트` 버스 
  -  사용자의 애플리케이션 이벤트용
- `스키마` 레지스트리
  - 스키마 모델을 설정 가능

<br><br><br><br>

---------------------------------------
## AWS CloudWatch insights and operational visibility (인사이트 및 운영 가시성?)


<br><br>

- Logs insights는 `row 데이터를 마음대로 조작 할 수 있다`(SQL같이)

![Alt text](../../etc/image2/%ED%81%B4%EB%9D%BC%EC%9A%B0%EB%93%9C%EC%99%80%EC%B9%98%EB%A1%9C%EA%B7%B8%EC%9D%B8%EC%82%AC%EC%9D%B4%ED%8A%B8.png)

<br><br><br><br>

- CloudWatch insights 종류
  - `container`
    - 컨테이너 로그,매트릭을 수집,집계,요약 하는 서비스
    - ECS, EKS, 파게이트등
    - 컨테이너화된 버전의 `클라우드와치 에이전트`를 사용해야됨
  - `Lambda`
    - 람다에서 실행되는 로그,매트릭 수집,집계,요약
    - cpu,메모리,디스크 등
    - `람다 레이어`로 제공됨
    - `서버리스 애플리케이션`을 모니터링할때, 필요
  - `contributor` (기고자)
    - VPC,DNS 등 `AWS가 생성한 모든 로그`에서 동작
    - `상위 N개 등 특정 로그 찾을때 쓰임`
    - 예) DNS로그에서 오류를 가장 많이 생성하는 URL을 찾을 수 있음
    - 예) 네트워크 요청에 대해 가장 많이 사용하는 곳은 어디?
      - VPC flow -> 클라우드와치 로그 -> 클라우드와치 컨트리부트 인사이트 -> SQL 쿼리쳐서 패킷량 상위 10개 찾음
  - `application`
    - 내 어플리케이션에 적용해서 볼 수 있음
    - EC2에 자바,닷넷 어플리케이션, 등 내 어플리케이션 정보를 가지고 `자동화된 대시보드` 생성( `세이지메이커로 생성됨` )

<br><br><br><br>

--------------
## AWS CloudTrail

<br><br>

- AWS 계정의 `거버넌스(governance - 통치),감사 및 규정 준수를 돕는다`
  - `거버넌스 (Governance)`
    - AWS에서 거버넌스는 기업이 `AWS 리소스와 서비스를 적절하게 관리하고 통제하기 위한 프로세스와 정책을 구현하는 것`을 의미합니다. AWS에서는 Identity and Access Management (IAM)을 통해 사용자와 그룹에 대한 권한을 관리하고, AWS 리소스에 대한 액세스를 제어할 수 있습니다. 또한, AWS의 조직(Organizations) 서비스를 사용하여 다중 AWS 계정을 관리하고 중앙 집중식 계정 구성을 구현할 수 있습니다.
  - `감사 (Audit)`
    - AWS에서 감사는 AWS CloudTrail 서비스를 통해 수행됩니다. CloudTrail은 AWS 계정 내에서 수행되는 모든 API 호출과 관리 작업에 대한 로그를 생성하고 저장합니다. 이를 통해 누가, 언제, 어떤 작업을 수행했는지 추적하고, 보안 이슈를 탐지하며, 문제를 식별할 수 있습니다. 감사 로그는 CloudTrail 콘솔 또는 다른 AWS 서비스와 통합하여 모니터링하고 분석할 수 있습니다.
  - `규정 준수 (Compliance)`
    - AWS는 다양한 규정 준수 요구사항을 충족하기 위해 많은 노력을 기울이고 있습니다. 예를 들어, 개인정보 보호를 위한 GDPR, HIPAA, PCI DSS 등과 같은 규정 준수를 위한 서비스와 지침을 제공합니다. `AWS Config 서비스를 통해 규정 준수 요구사항에 따라 리소스 구성을 모니터링하고 평가하여 문제를 식별하고 개선할 수 있습니다.` 또한, `AWS Artifact` 서비스를 통해 AWS의 규정 준수에 관한 보고서와 문서를 쉽게 얻을 수 있습니다.
- 기본적으로 활성화 되어 있고, 콘솔,SDK, CLI 등 모든 변동 사항을 볼 수 있다.
- `글로벌 서비스` 단, 단일 리전 추적도 가능
- 로그는 클라우드워치 logs나, S3로 옮길 수 있다 -> `모든 리전 기록을 한곳에 모을수도 있음`
- `기본으로 90일 보관` (https://aws.amazon.com/cloudtrail/pricing/)


<br><br><br><br>

- CloudTrail Tvents (3가지 있음)
  - `관리 이벤트`
    - AWS계정의 리소스에서 수행되는 작업 (`기본적으로 활성화되있음`)
    - 예) ec2 생성, IAM 역할 추가 등
    - 관리이벤트는 또, 2가지로 나뉜다
      - 읽기 이벤트 (리소스 수정 X)
      - 쓰기 이벤트 (리소스 수정 O) `중요도가 높다`
  - `Data 이벤트`
    - 기본적으로 로깅 X (`활성화 해줘야함`)
    - 예) S3 Getobject, deleteobject 등 좀 세부적인 로깅
    - 예) 람다 Invoke API (호출)
  - `Cloudtrail Insights 이벤트`
    - `이벤트를 분석해서 계정내 특이한 활동을 탐지`
    - 예)
      - 서비스 한도 도달
      - 부정확한 리소스 프로비저닝
      - IAM 작업 버스트 (일시적이고 강력한 활동 - 권한 변경 등)
      - `주기적 유지관리 작업 부재`

- 클라우드트레일 + 이벤트브릿지로 위험한 상황을 컨트롤 할 수 있음

![Alt text](../../etc/image2/%ED%81%B4%EB%9D%BC%EC%9A%B0%EB%93%9C%ED%8A%B8%EB%A0%88%EC%9D%BC%EC%9D%B4%EB%B2%A4%ED%8A%B8%EB%B8%8C%EB%A6%BF%EC%A7%80.png)


<br><br><br><br>


-----------------------------------------------
## AWS config

<br><br>

- config는 AWS 내, 리소스 변경사항에 대한 세밀한 기록
- 리전 서비스임 (글로벌 아님)
- `활성화 해줘야함` (기본값으로 비활성화)
- config를 활성화, 기록을 남기고, 로그 기록 기반 조건 검사로 `리소스 감사`를 실시 할 수 있음
  - 예) 
    - 버킷에 공용 액세스가 있나?
    - 지금 보안그룹중에 아웃바운드 트래픽 중, 특정아이피 허용이 있나?
- 이것도, 클라우드 트레일과 마친가지로 S3에 저장하여 모든 리전별 로그를 한곳으로 모을 수 있음

<br><br>

- Config Rule
  - AWS Config를 활성화 할 때, 규칙을 설정 할수도 있음, 규칙은 고객이 만들수도 있음 -> `규정 준수 여부 척도가 됨`
  - config rule에 의해 무엇인가 `기능적으로 차단은 불가능` -> 고객에게 알림은(이벤트브릿지 -> SNS) 가능
  - `즉, 조건문과 비슷`
  - 예) ![Alt text](../../etc/image2/config%EB%A3%B0.png)
  - `서비스 할당량을 확인`하는 AWS 구성 "관리형 규칙"은 `없음`
- 만약, 규정 준수 위반을한 리소스가 있으면, `remediation action`(수정 조치)을 설정 (`이건 실습 필요!!!!`)

<br><br>

- `AWS config Remediation`(수정)
  - 규정 위반을 자동,수동으로 수정해줌
- `AWS config 알람`
  - 규칙 위반을 알림


<br><br><br><br>



---------------------------------------------
## AWS CloudWatch Vs AWS CloudTrail Vs AWS Config

<br><br>

- CloudWatch
  - 자원 리소스를 모니터링하고, 대시보드를 만드는데 사용
  - 이벤트와 알림을 받을수 있음
  - 로그 집계, 분석도구 사용 가능
- 클라우드 트레일
  - AWS 계정내, 모든 API 호출을 기록
  - 특정 리소스에 대한 추적 가능
  - `글로벌 서비스`
- AWS Config
  - 리소스 구성 변경을 기록
  - 규정 준수 규칙(rule)에 따라, 리소스 현재 구성을 평가할 때 사용, 규정 준수와 연관있음 

- AWS Config에서 리소스 `변경사항에 대해 수정한 계정이나 IAM 역할 나옴`


<br><br><br><br>



-----------------------------------------
## AWS Audit manager (감사 매니져)

<br><br>

 - `AWS 사용량`을 `지속적으로 감사`하여 위험과 규정 및 산업 표준의 준수를 평가하는 방법을 간소화하는 데 도움이 됩니다. 
 - 장점
   -  `AWS 사용량을 제어에 쉽게 매핑`
   -  자동 증거 수집으로 시간 절약
   -  팀간 협업 간소화 
   -   항상 감사 준비 보고서를 작성할 준비
 - 단, AWS `외부`에서 생성된 자료는 `수동으로 S3에` 업로드 해줘야함


























